---
layout: onepoint/post
title: Vous allez finir par les aimer les `Optionals` ?
description: Essayons de mieux comprendre et mettre les `Optional`
tags: [java]
authors: [jtama]
---


> **_NOTE:_** Ceci est une retranscription par l'excellent https://dev.to/eplumas[Emmanuel Plumas] de https://youtu.be/0LVkoF5D1eE[la conf√©rence que j'ai donn√© TouraineTech 2023], un tr√®s grand merci √† lui ‚ù§Ô∏è.

D'apr√®s la documentation officielle d' _Oracle_, un optional est un conteneur d‚Äôobjet qui peut (ou pas) √™tre null.

Une fois qu'on a dit √ßa, on n'est pas bien avanc√© !

Si les `optionals` existent c'est avant tout pour donner une vision √† un tiers, pour lui indiquer une intention, certainement pas pour √©viter des `NullPointerException`.

Pinky and the brain vont nous aider √† prendre tout √ßa en main.

[.dialog]
--
==
[.replica.right]
==
[.who]
image:{site.url('/static/assets/images/optionals/pinky.png')}[.avatar]Pinky
[.what]
Coucou ! üëã

[.replica.left]
==
[.who]
image:{site.url('/static/assets/images/optionals/brain.png')}[.avatar]The brain
[.what]
Oui voil√†, c'est √ßa, bonjour.
==
--


== Quand les utiliser ?


On peut par exemple les utiliser quand on repr√©sente le monde ext√©rieur. Il ne nous est en effet pas possible de le contr√¥ler, en tout cas, nous n'en avons pas encore trouver le moyen.

Ici par exemple pour repr√©senter une configuration externe :


[source,java]
----
public class LeMondeExterieurConfig {
	private Optional<String> login;
	private Optional<String> password;
	private Optional<Boolean> skiplogin;
}
----


Cela veut dire que je sais que ce qui arrive de l‚Äôext√©rieur peut √™tre `null`.
Remarquez que ces propri√©t√©s sont `private`, ce qui signifie qu'il est fort probable que je ne les laisserai pas sortir de ma classe en l'√©tat.

On verra plus tard ce que pinky faif de ces donn√©es.

On peut √©galement les utiliser quand on acc√®de soi-m√™me au monde ext√©rieur, par exemple dans un _repository_.


[source,java]
----
public interface LeMondeExterieurAcces {
	Optional<Person> findById(UUID id);
	List<Person> findByName(String name);
	Person findByNir(String nir) throws NotFoundException;
}
----

Ces trois signatures indiquent trois intentions diff√©rentes :

1. `findById` peut renvoyer la valeur `null` et selon les cas les traitements pourraient √™tre diff√©rents. Si je veux en effet acc√©der √† l'utilisateur, alors il y a un probl√®me. Mais si je veux juste valider qu'il n'existe pas avant de l'ins√©rer, alors la nullit√© n'est pas un probl√®me.
1. `findbyName` renvoie un type `list`, aucun bonne raison de renvoyer `null`, un liste vide fera largement l'affaire.
1. `findByNir` renvoie directement un type `Person`, ici on indique clairement que le nullit√©  n'est pas possible, √ßa sera une donn√©e ou une exception.


== Qu‚Äôest-ce que j'en fais et comment j‚Äôutilise les `Optionals`

Nous allons illustrer plusieurs cas de traitement d'`optional` au travers de l'exemple d'une liste de course pour notre prochaine raclette.

[.dialog]
--
[.replica.left]
==
[.who]
image:{site.url('/static/assets/images/optionals/brain.png')}[.avatar]The brain
[.what]
C'est gentil de me laisser enfin la parole chez J√©r√¥me.

Puisque qu'on en est l√†, Pinky, merci d'aller faire les courses pour la raclette. Voil√† la liste:

image::{site.url('/static/assets/images/optionals/recette_raclette.png')}[Recette de raclette]
==
--

== Des patates Bintjes, sinon des Amandines: `orElse()`

[.dialog]
--
==
[.replica.right]
==
[.who]
image:{site.url('/static/assets/images/optionals/pinky.png')}[.avatar]Pinky
[.what]

Ahhhh ok j'ai tout compris, du coup c'est comme √ßa que je dois faire.

[source,java]
----
Patate patate;
Optional<Patate> maybePatate = getBintje()
if (maybePatate.isPresent()){
	patate = maybePatate.get();
} else {
	patate = amandine
}
----
[.replica.left]
==
[.who]
image:{site.url('/static/assets/images/optionals/brain.png')}[.avatar]The brain
[.what]
*Non Pinky! Comme d'habitude tu fais tout √† l'envers.*
C'est comme √ßa cher Pinky que tu devrais faire. Arr√™te tes b√™tises maintenant.

[source]
----
private Optional<Patate> getBintje() { ...}
Patate patate = getBintje().orElse(amandine);
----

==
--

Dans le cas de la repr√©sentation de la configuration externe, il est tr√®s probable que cette m√©thode `orElse()` soit celle que nous aurions utilis√©e pour assigner des valeurs par d√©faut.



== Si le boucher du centre a de la charcuterie prends-en, sinon va chez le boucher beaucoup plus loin : `orElseGet()`


[.dialog]
--
==
[.replica.right]
==
[.who]
image:{site.url('/static/assets/images/optionals/pinky.png')}[.avatar]Pinky
[.what]

Cette fois-ci, je fais tout bien regarde.

[source,java]
----
private Optional<Charcuterie> getCharcuterieDuCentre () {....}
private Charcuterie getCharcuteriePlusloin() {....}

Charcuterie = getCharcuterieDuCentre().orElse(getCharcuteriePlusLoin());
----
[.replica.left]
==
[.who]
image:{site.url('/static/assets/images/optionals/brain.png')}[.avatar]The brain
[.what]
Cela peut marcher avec un appel de m√©thode mais _Java_ est ainsi fait que les param√®tres d'une m√©thode sont √©valu√©s avant d'invoquer les m√©thodes !

On invoquera donc `getCharcuteriePlusLoin()` co√ªteuse en m√©moire/en temps/ce qu'on veut, alors qu'on ne sait m√™me pas si on en a besoin.

La m√©thode `orElseGet()` qui prend en param√®tre un `Supplier` nous permet de n'invoquer la m√©thode co√ªteuse qu'une fois qu'on est certain que c'est n√©cessaire.


[source,java]
----
private Optional<Charcuterie> getCharcuterieDuCentre () {....}
private Charcuterie getCharcuteriePlusloin() {....}
Charcuterie = getCharcuterieDuCentre()
		.orElseGet(() -> getCharcuteriePlusLoin());
----

Le `supplier` ne sera ex√©cut√© que s‚Äôil y en a besoin !
==
--


== Fromage √† raclette (ou panic) : `orElseThrow*`


[.dialog]
--
==
[.replica.right]
==
[.who]
image:{site.url('/static/assets/images/optionals/pinky.png')}[.avatar]Pinky
[.what]
[source,java]
----
Fromage morbier = maybeFromage.orElseThrow(() -> new ThreadDeath());
----

[.replica.left]
==
[.who]
image:{site.url('/static/assets/images/optionals/brain.png')}[.avatar]The brain
[.what]
Ahh je suis fier de toi. Tu remarques que la m√©thode `orElseThrow()` prend √©galement un `supplier`.

On aurait pu faire un `orElseThrow()` qui prend directement en param√®tre une instance d'exception, mais leur instanciation √©tant co√ªteuse (notamment √† cause du m√©canisme de cr√©ation de _stack trace_), les d√©veloppeurs de l'API Java, ont l√† aussi choisi le pattern du `Supplier` pour retarder son instanciation.
==
--

== D'autres utilisations avanc√©es

D√©sol√©, la digestion de la raclette a √©t√© un peu difficile, et les exemples suivants ne viennent pas de ma liste de course.

image:{site.url('/static/assets/images/optionals/todos.png')}[Liste de t√¢che √† faire]


=== Si on trouve le prix du cadeau, on donne le prix, sinon on donne 20‚Ç¨

[.dialog]
--
==
[.replica.right]
==
[.who]
image:{site.url('/static/assets/images/optionals/pinky.png')}[.avatar]Pinky
[.what]
Alors l√† je suis d√©sol√©, je ne vois pas bien comment faire √ßa.

[.replica.left]
==
[.who]
image:{site.url('/static/assets/images/optionals/brain.png')}[.avatar]The brain
[.what]
Ici, en r√©alit√© nous ne sommes pas int√©ress√©s directement par le cadeaux mais uniquement par son prix, on ne veut pas traiter un `Optional<Cadeau>`, on aimerait un √íptional<Long>...

On peut utiliser la m√©thode `map()` afin d'effectuer cette transformation et ensuite lui appliquer un `orElse()`.


[source,java]
----

Long participation = cadeau
	.map(Cadeau::getPrix)
	.orElse(20L);

----
==
--



=== Si le caviste a du Touraine, on en prend

[.dialog]
--
[.replica.right]
==
[.who]
image:{site.url('/static/assets/images/optionals/pinky.png')}[.avatar]Pinky
[.what]
[source,java]
----
caviste.getTouraine()
   .map(...);
----

Heuu non, il va encore falloir m'aider

[.replica.left]
==
[.who]
image:{site.url('/static/assets/images/optionals/brain.png')}[.avatar]The brain
[.what]
La m√©thode `ifPresent()` est l√† pour toi !
[source,java]
----
caviste.getTouraine()
  .ifPresent(bouteille -> onEnPrend(bouteille));
----

Elle prend en param√®tre un `Consumer` !

La m√©thode `onEnPrend()` n‚Äôa plus √† se poser la question de la nullit√© de bouteille : on fait un appel conditionnel √† la m√©thode !

==
--

=== Si le caviste a du Touraine ET qu‚Äôil n‚Äôest pas trop cher, on en prend

[.dialog]
--
[.replica.right]
==
[.who]
image:{site.url('/static/assets/images/optionals/pinky.png')}[.avatar]Pinky
[.what]
[source,java]
----
caviste.getTouraine()
  .ifPresent(bouteille -> {
    if (pasTropCher(bouteille))
        onEnPrend(bouteille)
  });
----

L√†, j'ai bon, non ?

[.replica.left]
==
[.who]
image:{site.url('/static/assets/images/optionals/brain.png')}[.avatar]The brain
[.what]
Tu vas trop vite, tu ne lis pas la documentation. Encore une fois, une m√©thode est l√† pour toi, la m√©thode `filter`.

[source,java]
----

caviste.getTouraine()
	.filter(bouteille -> pasTropCher(bouteille)
	.ifPresent(bouteille -> onEnPrend(bouteille));

----

Elle prend un `Predicate`.

Les plus attentif d'entre vous auront remarqu√© que l'API des `Optional` rappelle beaucoup celle des `Stream`
--


=== Si le primeur est ouvert ET qu‚Äôil a de la mangue, on prend, sinon, on prend de l‚Äôananas

[.dialog]
--
[.replica.right]
==
[.who]
image:{site.url('/static/assets/images/optionals/pinky.png')}[.avatar]Pinky
[.what]
image::https://cdn.dribbble.com/users/3487172/screenshots/6364505/manga_cs5.gif[Gif d'un oiseau repr√©sentant l'incapcit√© √† faire.]

[.replica.left]
==
[.who]
image:{site.url('/static/assets/images/optionals/brain.png')}[.avatar]The brain
[.what]
Rh√¢√¢√¢√¢√¢√¢

[source,java]
----

maybePrimeur //Optional<Primeur>
	.map(primeur -> primeur.getMangue()); //Optional<Optional<Fruit>>

maybePrimeur //Optional<Primeur>
	.flatmap(primeur -> primeur.getMangue()) //Optional<Fruit>
	.orElse(new Ananas());

----

Comme sur un stream, ces op√©rations ne sont pas terminales, mais seront execut√©es au moment o√π on fait un `get()` ou un `orElse()`.  En fait, on programme un _pipeline_ de traitement.
--

=== Si je trouve les clefs dans mon sac je les utilise, sinon je passe par la fen√™tre


[.dialog]
--
[.replica.right]
==
[.who]
image:{site.url('/static/assets/images/optionals/pinky.png')}[.avatar]Pinky
[.what]
image::https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExc21iOWI1NGMxaTVlMzA4NzdxMWJuejN6Mjdjc202azBkdzYyeWdkbSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/GeTJb2rMvZCne/giphy.webp[Gif de pinky.]

Tu vas _encore_ essayer de conqu√©rire le monde ?

[.replica.left]
==
[.who]
image:{site.url('/static/assets/images/optionals/brain.png')}[.avatar]The brain
[.what]
Tais-toi, sot.

[source,java]
----
maybeClef
  .ifPresentOrElse(
     clef -> utilise(cle),
	() -> passeParLaFenetre());
----

Malheureusement la m√©thode `ifAbsent()` n‚Äôexiste pas sur les `Optionals`, On est oblig√© de faire du `isEmpty()`ce qui sera toujours mieux que `!isPresent()`.
--

== Ce qu'on ne veut plus jamais voir...

[source,java]
----
if(optional.isPresent()) {
    var value = optional.get();
}
----

[source,java]
----
String code = Optional.ofNullable(app.getCodeImputationDefaut())
	.orElse("");
----

Non et non, c'est au service de fournir  la valeur par d√©faut...


